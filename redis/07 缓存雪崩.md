# 缓存雪崩

## 缓存雪崩的表现

缓存雪崩是指在高并发的情况下，大量请求打到redis缓存中，突然redis因为一些原因无法正常为外部提供服务，或者是命中的缓存在同一时间大量失效，导致原先应该打在redis缓存中的请求全部打到数据库。

## 缓存雪崩的危害

当出现缓存雪崩时，大量请求打到数据库，由于redis与数据库两个不同组件间的性能差异，原本redis能够处理的海量请求，mysql无法处理，导致mysql被打死，影响整个系统的运行

## 如何避免缓存雪崩

redis宕机引起的雪崩：

1. 避免使用单机redis，任何单机的服务都会有单点问题。
2. redis至少需要从其高可用的方案中选取一个，主从（需要手动切换，但是比单点恢复快），主从+哨兵（一旦哨兵发现主节点不可用，会从从节点中选取一个升级为主），集群方案（终极方案，基本不会出现redis不可用的情况）
3. 如果极端情况下redis确实没法对外服务了，做好服务降级的策略，拒绝一部分请求，只允许一部分mysql能够处理的请求进入到代码逻辑，其他请求都返回友好提示

redis同一时间大量key失效引起雪崩：

1. 这个问题可以在设置失效时间时设置一个随机的后缀时间，防止大量key一起失效导致数据库压力变大
2. 在某个key失效，然后重新去mysql加载时，需要对该key加锁，并使用双重检查，这样每次key失效只会有一个请求打到数据库
3. 设置随机过期时间避免了同一时间大量不同key过期，双重检查可以使得即使某个key过期也只会有一个请求访问数据库

