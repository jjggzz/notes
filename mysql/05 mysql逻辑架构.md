# mysql逻辑架构

## 架构

mysql的DMBMS从逻辑上分为三层：**连接层**、**服务层**、**引擎层**。

连接层：主要处理客户端发起的连接。由于会同时处理多个长链接。所以这里会使用池化技术来处理提交的请求。

服务层：主要接受sql指令（**sql接口 SQL Interface**），对sql进行语法分析和词法分析，最终形成一个语法树（**sql解析器 Parser**），对sql进行优化（**sql优化器 Optimizer**），如果有可能会进行缓存查找从而减少磁盘的IO次数（**缓存 Caches**）（8.0版本中被移除）。

引擎层：真正对物理磁盘上的数据进行查找工作，这一层是可插拔的，根据不同的引擎实现数据组织方式和查询行为也不同。

## sql执行流程

1. 连接层处理连接请求
2. 尝试通过查询缓存获取结果（取决于mysql版本，mysql8.0没有缓存）
3. sql接口接收提交的sql文本，在执行完成后返回结果文本
4. sql解析器对sql文本进行词法分析和语法分析，最终形成一颗语法树
5. sql优化器对sql进行优化，决定选用什么索引等等
6. 具体的数据库引擎对磁盘上的数据进行扫描，最终获取到需要的数据
7. 将结果放到缓存中（取决于mysql版本，mysql8.0没有缓存）

### sql解析器

sql解析器先对sql进行词法分析，判断sql的输入有没有问题，再进行语法分析，判断sql的语法层面有没有问题。进过sql解析器后，mysql就知道了这条sql是要进行什么操作了

### sql优化器

sql优化器主要对sql进行优化，包括决定使用索引还是全表扫描。一般是通过改变sql语句来使sql查询更加高效。通常采用**等价变换**、**重写**、等等，还会对比cost，从中选取cost最小的作为**执行计划**。

### sql执行器

sq执行器会判断用户是否有执行这条sql的权限，如果有那么会打开表进行执行，此时执行器会根据表的引擎定义调用具体引擎进行读写（引擎层）（此处应该是一个SPI的设计，即上层通过抽象进行调用，下层具体实现可以有不同的实现）。

