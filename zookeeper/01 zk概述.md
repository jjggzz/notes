# zk概述

zookeeper是雅虎研究院研究，后来捐赠给了apache。它是一个开源的分布式应用协调器，为分布式系统提供**一致性**服务。它的一致性是通过Paxos算法的ZAB协议完成的。它的主要功能有：配置维护、域名服务、分布式同步、集群管理等

## zk特性

zookeepr主要提供：

1. **顺序一致性**：它会按照接收到到顺序，执行请求，保证写入的顺序性
2. **原子性**：数据写入成功之后一定能够看到写入的结果，如果失败则不会影响结果
3. **单一视图**：数据写入之后无论从哪个节点读取，数据都是一样的
4. **可靠性**：非临时节点写入成功后数据将会一直保存下来，直到另一个事务对其进行了变更
5. **最终一致**：zk能够保证数据写入后在很短的一段时间里数据能够同步到其它节点，此时zk是不会响应读请求的

## zk数据结构

zk的数据结构与unix非常相似，但是它没有引入文件与目录的概念，而是使用了znode的数据节点概念。znode是zk中数据最小单元，**每个znode上都可以保存数据（最大1M），同时还可以挂载子节点**

### 节点类型

zk中节点有四种类型：

1. 持久节点：创建后一直保存在zk中，直到将其删除
2. 持久顺序节点：父节点可以为它的第一级子节点维护一份顺序，记录其创建顺序。在创建时会在子节点名称后面添加数字后缀作为节点的完整节点名
3. 临时节点：临时节点的生命周期与会话绑定，会话消失节点就会被自动清理，**临时节点只能作为叶子结点**
4. 临时顺序节点：添加了顺序号的临时节点

## zk的watch

zk支持发布订阅的监听操作。

1. zk客户端可以生成watch对象，并存放到watchManager
2. 向server注册watcher
3. 服务端发生了watcher事件
4. 向client发送相应事件通知
5. 根据通知从watchManager中找到watch对象
6. watch对象执行相应回调

watch是一次性的，被触发后，就会被删除，需要重新向zk注册watch，这会导致有些事件的监听可能会丢失。对于这种情况zk官方也给出了理由：如果zk集群触发事件很频繁会影响到客户端。所以**watch机制不适合监听变化很频繁的事件和会发生阻塞（IO）的事件**