# 消费幂等

​	当出现对某条消息重复消费时，多次消费与一次消费结果相同，并且并未对业务造成负面影响，则称为消息幂等，**消息幂等是非常重要的**

## 什么情况下会出现重复消息

发送消息时重复：producer发送消息到broker，broker保存成功，在响应之前网络闪断，此时producer以为失败，再次投递该消息，这两条消息内容相同，messageId也相同

消费时消息重复：消息被客户端处理之后，提交offset的时候发生网络闪断，broker未收到消费成功的响应，会再次向消费者发送该消息，这两条消息内容相同，messageId也相同

rebalance时重复：默认情况下offset是异步提交的，如果出现rebalance则有可能出现重复消费

## 通用解决方案

幂等令牌：生产者和消费者两者的约定，**通常是指具备唯一业务标识的字符串**

唯一性处理：服务端采用一定的算法策略，保证同一个业务逻辑不会被执行多次

对于常见的系统，幂等的通用解决方案为：

1. 首先通过缓存，在缓存中查看是否已经存在了某个令牌了，如果存在则说明是重复操作，若不存在则进入下一步
2. 在数据库中查询是否存在该令牌，如果存在则认为是重复操作，否则进入下一步
3. 在同一事务中完成三项操作：唯一性处理后，将令牌写入到数据库，将令牌写入到缓存

> 