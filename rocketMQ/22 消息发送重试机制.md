# 消息发送重试机制

1. 生产者在使用同步或者异步的方式发送消息时如果失败则会进行重试，**单向消息发送失败不会进行重试**
2. 只有普通消息有重试机制，**顺序消息没有重试机制**
3. 消息重试机制会造成消息重复，这是无法避免的问题
4. 消息重复无法避免，所以要保证下游的幂等性

## 消息发送重试策略

#### 同步发送失败重试策略

对于普通消息，默认采用轮询方式进行发送，如果发送失败，默认重试2次（可配置）。重**试时不会选择上次失败的broker**，如果只有一个broker则会选择其他queue（这就是顺序消息没有重试机制的原因）

如果超过重试次数，会抛出异常，由业务部分自己去处理

#### 异步发送失败重试策略

异步发送失败，仅会在同一broker上进行重试，所以不能保证消息不丢失

#### 消息刷盘失败策略

消息刷盘超时或者slave不可用时，默认是不会将消息发送到其他broker的。对于重要消息可以在broker配置配置项进行重试

## 消息消费重试策略

#### 顺序消息消费重试

对于顺序消息，如果消费者消费失败，为了保证顺序性，会一直重试时间间隔默认是1000ms，直到成功，**重试期间会出现消费阻塞**

顺序消息无生产重试，但是有消费重试

#### 无序消息消费重试

无序消息消费失败时可以通过**设置状态**达到消息重试效果，这种**重试只对集群消费有效**，对于广播消费消费失败后不再重试，会继续消费后续消息。

默认情况下重试会进行16次，每次时间间隔会变长，如果将次数调高，则16次之后，每次间隔2小时。消费者的配置会应用到同组所有消费者，如果消费者组中消费者配置不一样，采用覆盖方式，**最后应用的值会覆盖前面的**消费者。如果**达到重试上限，还是无法消费，那么会投递到死信队列**

## 重试队列

无序消息的消费重试实现是基于重试队列的。consumer并不是等待某个时长之后再去拉取原来的消息进行消费。而是将需要重试的消息放入到了一个特殊的topic的队列中，而后进行再次消费的。

当某个消费者组需要重试消费某个topic的消息时，rocketMQ会为每个消费者组都创建一个Topic名称为

%REREY%consumerGroup@consumerGroup的重试队列，例如：%REREY%test-group@test-group

> 1）因为一个topic会有多个消费者组订阅，所以这个重试队列是针对组的
>
> 2）只有出现需要重试消费的消息时，才会创建

rocketMQ的消息消费重试是通过延迟队列实现的，如果消息需要消费重试，那么会丢到SCHEDULE_TOPIC_XXXX中，延迟时间到了之后会丢到%REREY%consumerGroup@consumerGroup中，如果失败则再次扔回SCHEDULE_TOPIC_XXXX

## 如何控制

在**集群消费模式**下，如果消费失败，我们想要进行消费重试可以有以下三种做法：

1. 返回ConsumerConcurrentlyStatus.RECONSUME_LATER
2. 返回null
3. 抛出异常